{% extends "base.html" %}

{% block title %}Health Insights{% endblock %}

{% block content %}
    <!-- Main Content Section -->
    <main class=" flex flex-col justify-center items-center gap-6">
        <span class="text-red-500 font-bold" style="font-size: 72px;">Pulse Rate Detection using Webcam</span>
        <div class="flex gap-10 items-center justify-center">
        <div class="overflow-hidden bg-red-100 rounded-lg shadow-lg p-4 flex flex-col justify-center" style="width: fit-content;">
        <!-- Video Containers -->
        <div class="video-container">
            <!-- Heart Video -->
            <!-- <div class="heart-video" id="heartVideo">
                <img id="heart-gif" src="{{ url_for('static', filename='images/heart.gif') }}" alt="Heart GIF">
            </div> -->
            <!-- Webcam Feed -->
            <div class="webcam-feed">
                <img id="video-feed" src="{{ url_for('video_feed') }}" alt="Webcam Feed">
            </div>
        </div>
        <!-- Heart Rate Display -->
        <div class="flex items-center justify-center">
            <img src="{{ url_for('static', filename='images/heartAnimation.gif') }}" alt="" width="150px" />
            <p id="heart-rate" class="font-semibold">Click on Start Button</p>
        </div>
        <!-- Start and Stop Buttons -->
        <div class="buttons flex justify-center gap-2 mt-4">
            <button id="startButton" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Start Pulse Detection</button>
            <button id="stopButton" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Stop Pulse Detection</button>
        </div>

        </div>
        <!-- Chart Container -->
        <div id="pulseChartContainer">
            <canvas id="pulseChart" width="800" height="400"></canvas>
        </div>
    </div>
       
    </main>
    <!-- Include Chart.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <!-- JavaScript to be executed when the DOM is fully loaded -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var ctx = document.getElementById("pulseChart").getContext("2d");
            var heartRateChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: [],
                    datasets: [{
                        label: "Heart Rate (BPM)",
                        data: [], // Initial data, empty
                        borderColor: "rgb(255, 99, 132)",
                        borderWidth: 2,
                        fill: false,
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: "BPM",
                            },
                        },
                    },
                },
            });
        
            // Define the interval ID and the detection state
            var updateInterval;
            var detectionActive = false;
        
            function startPulseDetection() {
                if (!detectionActive) {
                    detectionActive = true;
                    fetch("/start_stream")
                        .then(response => {
                            if(response.ok) {
                                console.log("Streaming started");
                                // Force refresh of the webcam feed
                                const videoFeedElement = document.getElementById("video-feed");
                                const src = videoFeedElement.getAttribute("src");
                                videoFeedElement.setAttribute("src", ""); // Clear src
                                videoFeedElement.setAttribute("src", src); // Reassign to trigger load
                                
                                // Start the heart rate detection
                                updateInterval = setInterval(updateHeartRate, 1000);
                            }
                        })
                        .catch(error => console.error('Error starting streaming:', error));
                }
            }


            function stopPulseDetection() {
                if (detectionActive) {
                    clearInterval(updateInterval);
                    detectionActive = false;
                    // Stop the webcam stream from the server
                    fetch("/stop_stream")
                        .then(response => {
                            if(response.ok) {
                                console.log("Streaming stopped");
                                // Additional cleanup if necessary
                            }
                        })
                        .catch(error => console.error('Error stopping streaming:', error));
                }
            }

        
            // Attach event listeners to buttons
            document.getElementById("startButton").addEventListener("click", startPulseDetection);
            document.getElementById("stopButton").addEventListener("click", stopPulseDetection);
        
            // Update your existing updateHeartRate function here
            function updateHeartRate() {
                fetch("/get_heart_rate")
                    .then(response => response.json())
                    .then(data => {
                        // Update the heart rate display
                        document.getElementById("heart-rate").innerText = `Heart Rate: ${data.bpm.toFixed(2)} BPM`;
                        // document.getElementById("heartVideo").style.display = "none";
                        // document.getElementById("pulseChartContainer").style.display = "block";
                        // Add new data point to the chart
                        const newDataPoint = data.bpm.toFixed(2);
                        const newLabel = ""; // Placeholder for timestamp or label
                        // Add data to chart
                        heartRateChart.data.labels.push(newLabel);
                        heartRateChart.data.datasets.forEach(dataset => {
                            dataset.data.push(newDataPoint);
                        });
                        // Remove old data points if necessary to keep the chart clean
                        if (heartRateChart.data.labels.length > 20) {
                            heartRateChart.data.labels.shift();
                            heartRateChart.data.datasets.forEach(dataset => {
                                dataset.data.shift();
                            });
                        }
                        // Update the chart
                        heartRateChart.update();
                    })
                    .catch(error => {
                        console.error('Error fetching heart rate data:', error);
                    });
            }
        
        });
        </script>
        
{% endblock %}
